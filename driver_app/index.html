<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>CrashGuard-S | Driver</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,400&display=swap"
    rel="stylesheet" />
  <style>
    :root {
      --bg: #070d1a;
      --surface: #0f172a;
      --surface2: #162032;
      --surface3: #1e2d45;
      --border: #1e2d45;
      --border2: #263650;
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.35);
      --accent-dk: #1d4ed8;
      --green: #10b981;
      --green-glow: rgba(16, 185, 129, 0.35);
      --green-dk: #065f46;
      --red: #ef4444;
      --red-glow: rgba(239, 68, 68, 0.4);
      --red-dk: #991b1b;
      --amber: #f59e0b;
      --purple: #8b5cf6;
      --text: #f1f5f9;
      --muted: #475569;
      --muted2: #94a3b8;
      --radius: 18px;
      --radius-sm: 12px;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html,
    body {
      height: 100%;
      width: 100%;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    button {
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      border: none;
    }

    input {
      font-family: 'Inter', sans-serif;
    }

    /* â”€â”€ Screens â”€â”€ */
    .screen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
      overflow: hidden;
    }

    .screen.active {
      opacity: 1;
      pointer-events: all;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #screen-login {
      background: radial-gradient(ellipse 140% 90% at 60% -10%, #0f2550 0%, var(--bg) 55%);
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    #screen-login::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 80%, rgba(139, 92, 246, 0.08) 0%, transparent 50%);
      pointer-events: none;
    }

    .login-card {
      width: 100%;
      max-width: 420px;
      background: rgba(15, 23, 42, 0.85);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border2);
      border-radius: 28px;
      padding: 44px 36px;
      box-shadow: 0 32px 80px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.04);
      position: relative;
      z-index: 1;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 36px;
    }

    .brand-icon {
      width: 54px;
      height: 54px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 26px;
      box-shadow: 0 0 32px var(--accent-glow);
      flex-shrink: 0;
    }

    .brand-text h1 {
      font-size: 1.45rem;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .brand-text h1 span {
      color: var(--accent);
    }

    .brand-text p {
      font-size: 0.74rem;
      color: var(--muted2);
      margin-top: 3px;
      letter-spacing: 0.3px;
    }

    .login-title {
      font-size: 1.15rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .login-sub {
      font-size: 0.82rem;
      color: var(--muted2);
      margin-bottom: 28px;
    }

    .field {
      margin-bottom: 16px;
    }

    .field label {
      display: block;
      font-size: 0.72rem;
      font-weight: 600;
      color: var(--muted2);
      letter-spacing: 0.8px;
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .field input {
      width: 100%;
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 14px 16px;
      font-size: 1rem;
      color: var(--text);
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .field input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .field input::placeholder {
      color: var(--muted);
    }

    .btn-login {
      width: 100%;
      margin-top: 8px;
      padding: 16px;
      background: linear-gradient(135deg, var(--accent), var(--accent-dk));
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-weight: 700;
      color: #fff;
      box-shadow: 0 6px 24px var(--accent-glow);
      transition: opacity 0.2s, transform 0.15s, box-shadow 0.2s;
    }

    .btn-login:hover {
      box-shadow: 0 8px 32px rgba(59, 130, 246, 0.5);
    }

    .btn-login:active {
      transform: scale(0.98);
    }

    .login-error {
      margin-top: 14px;
      padding: 12px 16px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      font-size: 0.85rem;
      color: #fca5a5;
      display: none;
    }

    .creds-hint {
      margin-top: 24px;
      padding: 14px 16px;
      background: rgba(59, 130, 246, 0.06);
      border: 1px solid rgba(59, 130, 246, 0.18);
      border-radius: var(--radius-sm);
      font-size: 0.79rem;
      color: var(--muted2);
      line-height: 1.8;
    }

    .creds-hint strong {
      color: var(--accent);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOP BAR (shared) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    .topbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .topbar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }

    .topbar-brand .tb-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      box-shadow: 0 0 16px var(--accent-glow);
    }

    .topbar-brand h2 {
      font-size: 1rem;
      font-weight: 800;
    }

    .topbar-brand h2 span {
      color: var(--accent);
    }

    .driver-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 22px;
      padding: 5px 12px 5px 6px;
    }

    .driver-avatar {
      width: 28px;
      height: 28px;
      background: linear-gradient(135deg, var(--accent), var(--purple));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .driver-info .d-name {
      font-size: 0.78rem;
      font-weight: 600;
    }

    .driver-info .d-unit {
      font-size: 0.68rem;
      color: var(--muted2);
    }

    .btn-logout {
      width: 32px;
      height: 32px;
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #fca5a5;
      transition: background 0.2s;
    }

    .btn-logout:hover {
      background: rgba(239, 68, 68, 0.18);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STANDBY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #screen-standby {
      background: radial-gradient(ellipse 100% 60% at 50% -5%, #0d1f3a 0%, var(--bg) 65%);
    }

    .standby-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 28px 20px;
      gap: 0;
      overflow-y: auto;
    }

    .avail-card {
      width: 100%;
      max-width: 390px;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      padding: 18px 20px;
      margin-bottom: 28px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    }

    .avail-icon {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .avail-icon.on {
      background: rgba(16, 185, 129, 0.15);
    }

    .avail-icon.off {
      background: rgba(100, 116, 139, 0.12);
    }

    .avail-text {
      flex: 1;
    }

    .avail-label {
      font-size: 0.7rem;
      color: var(--muted2);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    .avail-status {
      font-size: 1rem;
      font-weight: 700;
      margin-top: 3px;
    }

    .avail-status.on {
      color: var(--green);
    }

    .avail-status.off {
      color: var(--muted2);
    }

    .toggle-wrap {
      position: relative;
    }

    .toggle-input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }

    .toggle-label {
      display: block;
      width: 56px;
      height: 30px;
      background: var(--border);
      border-radius: 15px;
      cursor: pointer;
      transition: background 0.3s;
      position: relative;
    }

    .toggle-label::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }

    .toggle-input:checked+.toggle-label {
      background: var(--green);
      box-shadow: 0 0 12px var(--green-glow);
    }

    .toggle-input:checked+.toggle-label::after {
      transform: translateX(26px);
    }

    /* GPS location pill */
    .gps-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 22px;
      padding: 7px 14px;
      font-size: 0.75rem;
      color: var(--muted2);
      margin-bottom: 24px;
      max-width: 390px;
      width: 100%;
    }

    .gps-pill .gps-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
      transition: background 0.3s;
    }

    .gps-pill.active .gps-dot {
      background: var(--green);
      box-shadow: 0 0 6px var(--green-glow);
    }

    .gps-pill .gps-coords {
      font-size: 0.72rem;
      color: var(--muted2);
      flex: 1;
    }

    /* Pulse */
    .pulse-wrap {
      position: relative;
      width: 130px;
      height: 130px;
      margin-bottom: 24px;
    }

    .pulse-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 2px solid var(--green);
      animation: pulse-expand 2.5s ease-out infinite;
    }

    .pulse-ring:nth-child(2) {
      animation-delay: 1.25s;
    }

    .pulse-core {
      position: absolute;
      inset: 16px;
      background: radial-gradient(circle, #10b981 0%, #065f46 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.8rem;
      box-shadow: 0 0 40px var(--green-glow);
    }

    .pulse-core.off-duty {
      background: radial-gradient(circle, #374151 0%, #1f2937 100%);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
    }

    @keyframes pulse-expand {
      0% {
        transform: scale(1);
        opacity: 0.7;
      }

      100% {
        transform: scale(2.4);
        opacity: 0;
      }
    }

    .standby-title {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 6px;
    }

    .standby-sub {
      font-size: 0.88rem;
      color: var(--muted2);
      text-align: center;
      max-width: 290px;
    }

    .stats-row {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 390px;
      margin-top: 28px;
    }

    .stat-card {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 14px;
      padding: 14px;
      text-align: center;
    }

    .stat-card .s-val {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--accent);
    }

    .stat-card .s-lbl {
      font-size: 0.68rem;
      color: var(--muted2);
      margin-top: 3px;
    }

    .demo-btn {
      margin-top: 24px;
      padding: 12px 28px;
      background: transparent;
      border: 1px solid var(--border2);
      border-radius: 10px;
      color: var(--muted2);
      font-size: 0.82rem;
      transition: all 0.2s;
    }

    .demo-btn:hover {
      border-color: var(--amber);
      color: var(--amber);
      background: rgba(245, 158, 11, 0.06);
    }

    .conn-pill {
      position: fixed;
      top: 68px;
      right: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 20px;
      padding: 5px 12px;
      font-size: 0.72rem;
      color: var(--muted2);
      z-index: 200;
    }

    .conn-pill .dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--muted);
    }

    .conn-pill.live .dot {
      background: var(--green);
      box-shadow: 0 0 6px var(--green-glow);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ALERT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #screen-alert {
      background: #080205;
    }

    #screen-alert.flash {
      animation: alert-flash 0.5s ease 4;
    }

    @keyframes alert-flash {

      0%,
      100% {
        background: #080205;
      }

      50% {
        background: #2a0505;
      }
    }

    .alert-topbar {
      background: linear-gradient(90deg, #b91c1c, #ef4444);
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      box-shadow: 0 4px 40px var(--red-glow);
      animation: alert-glow 1.2s ease-in-out infinite alternate;
    }

    @keyframes alert-glow {
      from {
        box-shadow: 0 4px 20px rgba(239, 68, 68, 0.5);
      }

      to {
        box-shadow: 0 4px 60px rgba(239, 68, 68, 1);
      }
    }

    .alert-topbar .at-icon {
      font-size: 1.8rem;
    }

    .alert-topbar h2 {
      font-size: 1rem;
      font-weight: 900;
      letter-spacing: 0.5px;
      flex: 1;
    }

    .alert-topbar .at-time {
      font-size: 0.74rem;
      opacity: 0.85;
    }

    .alert-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .a-card {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .a-card-head {
      padding: 10px 16px;
      background: rgba(239, 68, 68, 0.1);
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: #fca5a5;
    }

    .a-card-body {
      padding: 14px 16px;
    }

    #crash-snapshot {
      width: 100%;
      height: 190px;
      object-fit: cover;
      border-radius: 10px;
      background: #1a0000;
    }

    .info-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .info-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .info-item .ii-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
      margin-top: 2px;
    }

    .info-item .ii-lbl {
      font-size: 0.68rem;
      color: var(--muted2);
      margin-bottom: 2px;
    }

    .info-item .ii-val {
      font-size: 0.92rem;
      font-weight: 600;
    }

    .dist-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.35);
      border-radius: 8px;
      padding: 6px 14px;
      color: var(--amber);
      font-size: 1rem;
      font-weight: 700;
      margin-top: 8px;
    }

    .action-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 0 0 8px;
    }

    .btn-accept {
      padding: 20px 12px;
      background: linear-gradient(135deg, var(--green), var(--green-dk));
      border-radius: 15px;
      font-size: 1rem;
      font-weight: 800;
      color: #fff;
      box-shadow: 0 0 32px var(--green-glow);
      transition: transform 0.15s;
    }

    .btn-accept:active {
      transform: scale(0.96);
    }

    .btn-decline {
      padding: 20px 12px;
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      font-size: 0.95rem;
      font-weight: 700;
      color: #fca5a5;
      transition: background 0.2s;
    }

    .btn-decline:active {
      background: rgba(239, 68, 68, 0.14);
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EN ROUTE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    #screen-enroute {
      background: var(--bg);
    }

    .er-topbar {
      background: linear-gradient(90deg, #0f2044, #1e3a5f);
      padding: 13px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
    }

    .er-topbar .er-title {
      flex: 1;
    }

    .er-topbar .er-title h2 {
      font-size: 1rem;
      font-weight: 800;
    }

    .er-topbar .er-title p {
      font-size: 0.72rem;
      color: #93c5fd;
      margin-top: 2px;
    }

    .live-badge {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(16, 185, 129, 0.12);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 0.72rem;
      font-weight: 700;
      color: var(--green);
    }

    .blink {
      animation: blink 1s step-end infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0;
      }
    }

    #map {
      flex: 1;
      width: 100%;
      min-height: 0;
    }

    .er-sheet {
      background: var(--surface);
      border-top: 1px solid var(--border2);
      padding: 14px 16px;
      flex-shrink: 0;
    }

    .er-sheet-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .er-info-box {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--radius-sm);
      padding: 11px;
      text-align: center;
    }

    .er-info-box .eib-val {
      font-size: 1.25rem;
      font-weight: 800;
      color: var(--accent);
    }

    .er-info-box .eib-lbl {
      font-size: 0.65rem;
      color: var(--muted2);
      margin-top: 2px;
    }

    .er-address {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--radius-sm);
      padding: 11px 14px;
      margin-bottom: 10px;
      font-size: 0.84rem;
    }

    .er-turn-box {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(59, 130, 246, 0.07);
      border: 1px solid rgba(59, 130, 246, 0.2);
      border-radius: var(--radius-sm);
      padding: 10px 14px;
      margin-bottom: 10px;
      font-size: 0.82rem;
      color: #93c5fd;
    }

    .er-turn-box .turn-icon {
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .er-actions {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
    }

    .btn-arrived {
      padding: 15px;
      background: linear-gradient(135deg, var(--accent), var(--accent-dk));
      border-radius: 14px;
      font-size: 0.95rem;
      font-weight: 800;
      color: #fff;
      box-shadow: 0 4px 20px var(--accent-glow);
      transition: opacity 0.2s;
    }

    .btn-arrived:active {
      opacity: 0.85;
    }

    .btn-maps {
      padding: 15px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 14px;
      font-size: 0.82rem;
      font-weight: 700;
      color: var(--green);
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: background 0.2s;
    }

    .btn-maps:hover {
      background: rgba(16, 185, 129, 0.2);
    }

    /* â”€â”€ Toast â”€â”€ */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: 12px;
      padding: 12px 22px;
      font-size: 0.88rem;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      z-index: 9999;
      white-space: nowrap;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    #toast.show {
      opacity: 1;
    }

    /* â”€â”€ Spinner â”€â”€ */
    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* â”€â”€ Leaflet dark theme â”€â”€ */
    .leaflet-tile {
      filter: brightness(0.82) saturate(0.85) hue-rotate(5deg);
    }

    .leaflet-popup-content-wrapper {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border2);
      border-radius: 12px;
    }

    .leaflet-popup-tip {
      background: var(--surface2);
    }

    /* Route status banner */
    #route-status {
      position: absolute;
      bottom: 270px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border2);
      border-radius: 20px;
      padding: 6px 16px;
      font-size: 0.75rem;
      color: var(--muted2);
      z-index: 500;
      display: none;
    }

    #screen-enroute {
      position: relative;
    }
  </style>
</head>

<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="screen active" id="screen-login">
    <div class="login-card">
      <div class="brand">
        <div class="brand-icon">ğŸ›¡ï¸</div>
        <div class="brand-text">
          <h1>Crash<span>Guard</span>-S</h1>
          <p>Emergency Response System Â· Kerala</p>
        </div>
      </div>
      <div class="login-title">Driver Sign In</div>
      <div class="login-sub">Enter your badge ID and password to continue.</div>
      <div class="field">
        <label>Badge ID</label>
        <input type="text" id="inp-badge" placeholder="e.g. DRV-01" autocomplete="off" autocapitalize="characters" />
      </div>
      <div class="field">
        <label>Password</label>
        <input type="password" id="inp-password" placeholder="Enter password" />
      </div>
      <button class="btn-login" id="btn-login" onclick="doLogin()">Sign In</button>
      <div class="login-error" id="login-error"></div>
      <div class="creds-hint">
        <strong>Demo credentials:</strong><br>
        DRV-01 / driver01 &nbsp;Â·&nbsp; DRV-02 / driver02<br>
        DRV-03 / driver03 &nbsp;Â·&nbsp; DRV-04 / driver04
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â• STANDBY â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="screen" id="screen-standby">
    <div class="topbar">
      <div class="topbar-brand">
        <div class="tb-icon">ğŸ›¡ï¸</div>
        <h2>Crash<span>Guard</span>-S</h2>
      </div>
      <div class="driver-chip" id="driver-chip">
        <div class="driver-avatar" id="driver-avatar">?</div>
        <div class="driver-info">
          <div class="d-name" id="driver-name">â€”</div>
          <div class="d-unit" id="driver-unit">â€”</div>
        </div>
      </div>
      <button class="btn-logout" onclick="doLogout()" title="Sign out">â†©</button>
    </div>
    <div class="conn-pill" id="conn-pill">
      <div class="dot"></div>
      <span id="conn-label">Connectingâ€¦</span>
    </div>
    <div class="standby-body">
      <div class="avail-card">
        <div class="avail-icon off" id="avail-icon">ğŸ”´</div>
        <div class="avail-text">
          <div class="avail-label">Availability Status</div>
          <div class="avail-status off" id="avail-status-text">Off Duty</div>
        </div>
        <div class="toggle-wrap">
          <input type="checkbox" class="toggle-input" id="avail-toggle" onchange="toggleAvailability()" />
          <label class="toggle-label" for="avail-toggle"></label>
        </div>
      </div>

      <!-- GPS location pill -->
      <div class="gps-pill" id="gps-pill">
        <div class="gps-dot"></div>
        <span class="gps-coords" id="gps-coords-text">Acquiring GPS locationâ€¦</span>
      </div>

      <div class="pulse-wrap" id="pulse-wrap">
        <div class="pulse-ring"></div>
        <div class="pulse-ring"></div>
        <div class="pulse-core" id="pulse-core">ğŸš‘</div>
      </div>
      <div class="standby-title" id="standby-title">Awaiting Mission</div>
      <div class="standby-sub" id="standby-sub">You are on duty. You will be alerted instantly when a crash is
        dispatched to your unit.</div>
      <div class="stats-row">
        <div class="stat-card">
          <div class="s-val" id="stat-missions">0</div>
          <div class="s-lbl">Missions Today</div>
        </div>
        <div class="stat-card">
          <div class="s-val" id="stat-unit">â€”</div>
          <div class="s-lbl">Your Unit</div>
        </div>
        <div class="stat-card">
          <div class="s-val" id="stat-online">â€”</div>
          <div class="s-lbl">Units Online</div>
        </div>
      </div>
      <button class="demo-btn" onclick="simulateCrash()">âš¡ Simulate Crash [DEMO]</button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â• ALERT â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="screen" id="screen-alert">
    <div class="alert-topbar">
      <span class="at-icon">ğŸš¨</span>
      <h2>CRASH DETECTED â€” MISSION ASSIGNED</h2>
      <span class="at-time" id="alert-ts">â€”</span>
    </div>
    <div class="alert-scroll">
      <div class="a-card">
        <div class="a-card-head">ğŸ“· Accident Snapshot</div>
        <div class="a-card-body">
          <img id="crash-snapshot" src="" alt="Crash Snapshot" />
        </div>
      </div>
      <div class="a-card">
        <div class="a-card-head">ğŸ“ Crash Location</div>
        <div class="a-card-body">
          <div class="info-list">
            <div class="info-item">
              <span class="ii-icon">ğŸ—ºï¸</span>
              <div>
                <div class="ii-lbl">Address</div>
                <div class="ii-val" id="alert-address">â€”</div>
              </div>
            </div>
            <div class="info-item">
              <span class="ii-icon">ğŸŒ</span>
              <div>
                <div class="ii-lbl">GPS Coordinates</div>
                <div class="ii-val" id="alert-coords">â€”</div>
              </div>
            </div>
            <div class="info-item">
              <span class="ii-icon">ğŸ•</span>
              <div>
                <div class="ii-lbl">Detected At</div>
                <div class="ii-val" id="alert-time">â€”</div>
              </div>
            </div>
          </div>
          <div class="dist-pill" id="alert-dist">ğŸ“ â€” km away</div>
        </div>
      </div>
      <div class="action-grid">
        <button class="btn-accept" onclick="acceptMission()">âœ… ACCEPT MISSION</button>
        <button class="btn-decline" onclick="declineMission()">âœ– DECLINE</button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â• EN ROUTE â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="screen" id="screen-enroute">
    <div class="er-topbar">
      <span style="font-size:1.5rem">ğŸš‘</span>
      <div class="er-title">
        <h2>EN ROUTE TO CRASH SITE</h2>
        <p id="er-unit-label">Unit â€” | Mission #â€”</p>
      </div>
      <div class="live-badge"><span class="blink">â—</span> LIVE</div>
    </div>

    <div id="map"></div>
    <div id="route-status">ğŸ“¡ Fetching road routeâ€¦</div>

    <div class="er-sheet">
      <div class="er-sheet-row">
        <div class="er-info-box">
          <div class="eib-val" id="er-dist">â€”</div>
          <div class="eib-lbl">km to site</div>
        </div>
        <div class="er-info-box">
          <div class="eib-val" id="er-eta">â€”</div>
          <div class="eib-lbl">min ETA</div>
        </div>
        <div class="er-info-box">
          <div class="eib-val" id="er-speed">â€”</div>
          <div class="eib-lbl">km/h speed</div>
        </div>
      </div>
      <div class="er-address">
        <span>ğŸ“</span>
        <span id="er-address">â€”</span>
      </div>
      <div class="er-turn-box" id="er-turn-box" style="display:none">
        <span class="turn-icon" id="turn-icon">â¡ï¸</span>
        <span id="turn-text">â€”</span>
      </div>
      <div class="er-actions">
        <button class="btn-arrived" onclick="markArrived()">ğŸ Mark as Arrived</button>
        <button class="btn-maps" id="btn-maps" onclick="openInMaps()">ğŸ—ºï¸ Maps</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast"></div>

  <script>
    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentDriver = null;
    let currentMission = null;
    let map = null, crashMarker = null, driverMarker = null, routeLayer = null;
    let alarmCtx = null, alarmTimer = null;
    let missionCount = 0;
    let watchId = null;
    let driverLat = null, driverLon = null, driverSpeed = null;
    let routeRefreshTimer = null;
    let gpsWatchId = null;

    // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const el = document.getElementById(id);
      el.classList.add('active');
      if (id === 'screen-alert') {
        el.classList.remove('flash');
        void el.offsetWidth;
        el.classList.add('flash');
      }
    }

    function toast(msg, dur = 3500) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), dur);
    }

    function fmtTime(iso) {
      try { return new Date(iso).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); }
      catch { return iso; }
    }

    function haversine(lat1, lon1, lat2, lon2) {
      const R = 6371, toR = Math.PI / 180;
      const dLat = (lat2 - lat1) * toR, dLon = (lon2 - lon1) * toR;
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * toR) * Math.cos(lat2 * toR) * Math.sin(dLon / 2) ** 2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    // â”€â”€ Alarm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startAlarm() {
      try {
        alarmCtx = new (window.AudioContext || window.webkitAudioContext)();
        let n = 0;
        alarmTimer = setInterval(() => {
          if (n++ > 16) { stopAlarm(); return; }
          const osc = alarmCtx.createOscillator();
          const gain = alarmCtx.createGain();
          osc.connect(gain); gain.connect(alarmCtx.destination);
          osc.frequency.setValueAtTime(980, alarmCtx.currentTime);
          osc.frequency.setValueAtTime(700, alarmCtx.currentTime + 0.18);
          gain.gain.setValueAtTime(0.45, alarmCtx.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, alarmCtx.currentTime + 0.45);
          osc.start(alarmCtx.currentTime);
          osc.stop(alarmCtx.currentTime + 0.45);
        }, 550);
      } catch (e) { }
    }

    function stopAlarm() {
      if (alarmTimer) { clearInterval(alarmTimer); alarmTimer = null; }
      if (alarmCtx) { try { alarmCtx.close(); } catch (e) { } alarmCtx = null; }
    }

    // â”€â”€ GPS (always-on background watch) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startBackgroundGPS() {
      if (!navigator.geolocation) return;
      const pillEl = document.getElementById('gps-pill');
      const coordsEl = document.getElementById('gps-coords-text');
      gpsWatchId = navigator.geolocation.watchPosition(pos => {
        driverLat = pos.coords.latitude;
        driverLon = pos.coords.longitude;
        driverSpeed = pos.coords.speed !== null ? (pos.coords.speed * 3.6).toFixed(0) : null; // m/s â†’ km/h
        if (pillEl) {
          pillEl.classList.add('active');
          coordsEl.textContent = `${driverLat.toFixed(5)}Â°N, ${driverLon.toFixed(5)}Â°E`;
        }
        // Update en-route map if active
        if (driverMarker && map) {
          driverMarker.setLatLng([driverLat, driverLon]);
        }
        if (driverSpeed !== null) {
          document.getElementById('er-speed').textContent = driverSpeed;
        }
      }, () => {
        if (coordsEl) coordsEl.textContent = 'GPS unavailable â€“ using base location';
      }, { enableHighAccuracy: true, maximumAge: 3000, timeout: 10000 });
    }

    // â”€â”€ OSRM Road Routing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchOSRMRoute(fromLat, fromLon, toLat, toLon) {
      const url = `https://router.project-osrm.org/route/v1/driving/${fromLon},${fromLat};${toLon},${toLat}?overview=full&geometries=geojson&steps=true`;
      try {
        const resp = await fetch(url, { signal: AbortSignal.timeout(8000) });
        if (!resp.ok) throw new Error('OSRM error');
        const data = await resp.json();
        if (!data.routes || data.routes.length === 0) throw new Error('No route');
        const route = data.routes[0];
        const coords = route.geometry.coordinates.map(([lon, lat]) => [lat, lon]);
        const distKm = (route.distance / 1000).toFixed(1);
        const etaMin = Math.ceil(route.duration / 60);
        // First step instruction
        let firstStep = null;
        try {
          const steps = route.legs[0].steps;
          if (steps && steps.length > 0) {
            const s = steps[0];
            firstStep = {
              instruction: s.maneuver?.instruction || s.name || 'Head towards crash site',
              type: s.maneuver?.type || 'depart'
            };
          }
        } catch (e) { }
        return { coords, distKm, etaMin, firstStep, raw: route };
      } catch (e) {
        return null; // fallback to straight line
      }
    }

    function maneuverIcon(type) {
      const icons = {
        'turn': 'â†©ï¸', 'depart': 'ğŸŸ¢', 'arrive': 'ğŸ',
        'merge': 'ğŸ”€', 'roundabout': 'ğŸ”„', 'fork': 'ğŸ´',
        'end of road': 'â›”', 'use lane': 'ğŸ›£ï¸',
      };
      return icons[type] || 'â¡ï¸';
    }

    // â”€â”€ Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function initMap(crashLat, crashLon) {
      if (map) { map.remove(); map = null; routeLayer = null; crashMarker = null; driverMarker = null; }

      const startLat = driverLat || 10.5276;
      const startLon = driverLon || 76.2144;

      map = L.map('map', { zoomControl: true }).setView(
        [(crashLat + startLat) / 2, (crashLon + startLon) / 2], 13
      );

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap', maxZoom: 19
      }).addTo(map);

      // Crash marker
      const crashIcon = L.divIcon({
        html: `<div style="background:#ef4444;border:3px solid #fff;border-radius:50%;
                     width:36px;height:36px;display:flex;align-items:center;
                     justify-content:center;font-size:18px;
                     box-shadow:0 0 20px rgba(239,68,68,0.9);">ğŸ’¥</div>`,
        className: '', iconSize: [36, 36], iconAnchor: [18, 18]
      });
      crashMarker = L.marker([crashLat, crashLon], { icon: crashIcon }).addTo(map)
        .bindPopup(`<b>ğŸš¨ Crash Site</b><br>${document.getElementById('er-address').textContent}`)
        .openPopup();

      // Driver marker
      const ambIcon = L.divIcon({
        html: `<div style="background:#10b981;border:3px solid #fff;border-radius:50%;
                     width:36px;height:36px;display:flex;align-items:center;
                     justify-content:center;font-size:18px;
                     box-shadow:0 0 20px rgba(16,185,129,0.8);">ğŸš‘</div>`,
        className: '', iconSize: [36, 36], iconAnchor: [18, 18]
      });
      driverMarker = L.marker([startLat, startLon], { icon: ambIcon }).addTo(map)
        .bindPopup(`<b>ğŸš‘ Your Position</b><br>${currentDriver?.unit_id}`);

      // Fetch OSRM route
      await drawRoute(startLat, startLon, crashLat, crashLon);

      // Auto-refresh route every 15 seconds
      if (routeRefreshTimer) clearInterval(routeRefreshTimer);
      routeRefreshTimer = setInterval(() => {
        if (driverLat && currentMission) {
          drawRoute(driverLat, driverLon, currentMission.crash_lat, currentMission.crash_lon);
        }
      }, 15000);
    }

    async function drawRoute(fromLat, fromLon, toLat, toLon) {
      const statusEl = document.getElementById('route-status');
      if (statusEl) { statusEl.style.display = 'block'; statusEl.textContent = 'ğŸ“¡ Fetching road routeâ€¦'; }

      const result = await fetchOSRMRoute(fromLat, fromLon, toLat, toLon);

      if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }

      if (result) {
        // Real road polyline
        routeLayer = L.polyline(result.coords, {
          color: '#3b82f6', weight: 6, opacity: 0.95,
          lineJoin: 'round', lineCap: 'round'
        }).addTo(map);

        // Also add a glow layer underneath
        L.polyline(result.coords, {
          color: '#60a5fa', weight: 12, opacity: 0.2,
          lineJoin: 'round', lineCap: 'round'
        }).addTo(map);

        document.getElementById('er-dist').textContent = result.distKm;
        document.getElementById('er-eta').textContent = result.etaMin;

        if (result.firstStep) {
          const turnBox = document.getElementById('er-turn-box');
          turnBox.style.display = 'flex';
          document.getElementById('turn-icon').textContent = maneuverIcon(result.firstStep.type);
          document.getElementById('turn-text').textContent = result.firstStep.instruction;
        }

        if (statusEl) { statusEl.textContent = 'âœ… Road route loaded'; setTimeout(() => { if (statusEl) statusEl.style.display = 'none'; }, 2000); }
      } else {
        // Fallback straight line
        routeLayer = L.polyline([[fromLat, fromLon], [toLat, toLon]], {
          color: '#f59e0b', weight: 5, dashArray: '12 6', opacity: 0.85
        }).addTo(map);
        const d = haversine(fromLat, fromLon, toLat, toLon);
        document.getElementById('er-dist').textContent = d.toFixed(1);
        document.getElementById('er-eta').textContent = Math.ceil(d / 60 * 60);
        if (statusEl) { statusEl.textContent = 'âš ï¸ Using straight-line (no internet)'; setTimeout(() => { if (statusEl) statusEl.style.display = 'none'; }, 3000); }
      }

      if (routeLayer) {
        map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
      }
    }

    // â”€â”€ Open in Google Maps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openInMaps() {
      if (!currentMission) return;
      const toLat = currentMission.crash_lat, toLon = currentMission.crash_lon;
      let url;
      if (driverLat && driverLon) {
        url = `https://www.google.com/maps/dir/${driverLat},${driverLon}/${toLat},${toLon}`;
      } else {
        url = `https://www.google.com/maps/dir//${toLat},${toLon}`;
      }
      window.open(url, '_blank');
    }

    // â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function doLogin() {
      const badge = document.getElementById('inp-badge').value.trim().toUpperCase();
      const password = document.getElementById('inp-password').value;
      const btn = document.getElementById('btn-login');
      if (!badge || !password) { showError('Please enter badge and password.'); return; }
      btn.innerHTML = '<span class="spinner"></span>';
      btn.disabled = true;
      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ badge, password })
        });
        const data = await res.json();
        if (!data.ok) { showError(data.error || 'Login failed'); return; }
        currentDriver = data.driver;
        document.getElementById('login-error').style.display = 'none';
        enterStandby();
        connectSSE();
        checkExistingMission();
        startBackgroundGPS();
      } catch (e) {
        showError('Server error. Is the server running?');
      } finally {
        btn.innerHTML = 'Sign In';
        btn.disabled = false;
      }
    }

    function showError(msg) {
      const el = document.getElementById('login-error');
      el.textContent = msg;
      el.style.display = 'block';
    }

    document.getElementById('inp-password').addEventListener('keydown', e => {
      if (e.key === 'Enter') doLogin();
    });

    // â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function doLogout() {
      await fetch('/api/logout', { method: 'POST' });
      currentDriver = null; currentMission = null;
      if (gpsWatchId) { navigator.geolocation.clearWatch(gpsWatchId); gpsWatchId = null; }
      if (routeRefreshTimer) { clearInterval(routeRefreshTimer); routeRefreshTimer = null; }
      showScreen('screen-login');
    }

    // â”€â”€ Standby â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function enterStandby() {
      const d = currentDriver;
      document.getElementById('driver-name').textContent = d.name;
      document.getElementById('driver-unit').textContent = d.unit_id;
      document.getElementById('driver-avatar').textContent = d.name[0];
      document.getElementById('stat-unit').textContent = d.unit_id;
      const toggle = document.getElementById('avail-toggle');
      toggle.checked = !!d.is_on_duty;
      updateAvailUI(!!d.is_on_duty);
      showScreen('screen-standby');
      loadStats();
    }

    function updateAvailUI(onDuty) {
      const icon = document.getElementById('avail-icon');
      const status = document.getElementById('avail-status-text');
      const core = document.getElementById('pulse-core');
      const title = document.getElementById('standby-title');
      const sub = document.getElementById('standby-sub');
      if (onDuty) {
        icon.className = 'avail-icon on'; icon.textContent = 'ğŸŸ¢';
        status.className = 'avail-status on'; status.textContent = 'On Duty';
        core.className = 'pulse-core';
        title.textContent = 'Awaiting Mission';
        sub.textContent = 'You are on duty. You will be alerted instantly when a crash is dispatched.';
      } else {
        icon.className = 'avail-icon off'; icon.textContent = 'ğŸ”´';
        status.className = 'avail-status off'; status.textContent = 'Off Duty';
        core.className = 'pulse-core off-duty';
        title.textContent = 'Off Duty';
        sub.textContent = 'Toggle the switch above to go on duty and receive mission alerts.';
      }
    }

    async function toggleAvailability() {
      const onDuty = document.getElementById('avail-toggle').checked;
      updateAvailUI(onDuty);
      const res = await fetch('/api/availability', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ on_duty: onDuty })
      });
      const data = await res.json();
      if (data.ok) {
        toast(onDuty ? 'âœ… You are now On Duty' : 'ğŸ”´ You are now Off Duty');
        if (currentDriver) currentDriver.is_on_duty = onDuty ? 1 : 0;
      }
      loadStats();
    }

    async function loadStats() {
      try {
        const res = await fetch('/api/ambulances');
        const ambs = await res.json();
        const online = ambs.filter(a => a.is_on_duty).length;
        document.getElementById('stat-online').textContent = online;
      } catch (e) { }
    }

    // â”€â”€ Alert screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showAlert(data) {
      currentMission = data;
      document.getElementById('alert-ts').textContent = fmtTime(data.timestamp);
      document.getElementById('alert-address').textContent = data.address || 'â€”';
      document.getElementById('alert-coords').textContent =
        `${Number(data.crash_lat).toFixed(5)}Â°N, ${Number(data.crash_lon).toFixed(5)}Â°E`;
      document.getElementById('alert-time').textContent = fmtTime(data.timestamp);
      document.getElementById('alert-dist').textContent = `ğŸ“ ${data.distance_km ?? '?'} km away`;
      const snap = document.getElementById('crash-snapshot');
      snap.src = data.snapshot_url + '?t=' + Date.now();
      showScreen('screen-alert');
      startAlarm();
    }

    // â”€â”€ En Route screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showEnRoute(data) {
      currentMission = data;
      document.getElementById('er-unit-label').textContent =
        `${currentDriver?.unit_id} | Mission #${data.crash_id}`;
      document.getElementById('er-address').textContent = data.address || 'â€”';
      document.getElementById('er-dist').textContent = data.distance_km ?? 'â€”';
      document.getElementById('er-eta').textContent = Math.ceil((data.distance_km || 5) / 60 * 60);
      showScreen('screen-enroute');
      setTimeout(() => initMap(data.crash_lat, data.crash_lon), 200);
    }

    // â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function acceptMission() {
      if (!currentMission) return;
      stopAlarm();
      const res = await fetch('/api/mission/accept', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ crash_id: currentMission.crash_id })
      });
      if ((await res.json()).ok) {
        missionCount++;
        document.getElementById('stat-missions').textContent = missionCount;
        toast('âœ… Mission accepted! Loading road routeâ€¦');
        showEnRoute(currentMission);
      }
    }

    async function declineMission() {
      if (!currentMission) return;
      stopAlarm();
      const res = await fetch('/api/mission/decline', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ crash_id: currentMission.crash_id })
      });
      const result = await res.json();
      if (result.reassigned_to) {
        toast(`â†© Declined. Crash re-dispatched to ${result.reassigned_to}`, 5000);
      } else {
        toast('â†© Declined. âš ï¸ No other units available â€” crash unassigned.', 5000);
      }
      currentMission = null;
      showScreen('screen-standby');
    }

    async function markArrived() {
      if (!currentMission) return;
      await fetch('/api/mission/arrived', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ crash_id: currentMission.crash_id })
      });
      if (routeRefreshTimer) { clearInterval(routeRefreshTimer); routeRefreshTimer = null; }
      toast('ğŸ Arrived! Mission resolved.');
      currentMission = null;
      showScreen('screen-standby');
      loadStats();
    }

    async function simulateCrash() {
      toast('âš¡ Simulating crash detectionâ€¦');
      const res = await fetch('/api/simulate_crash', { method: 'POST' });
      const data = await res.json();
      if (data.ok) toast(`Crash #${data.crash_id} â†’ dispatched to ${data.assigned_to || 'no unit'}`);
      else toast('âŒ No on-duty units available');
    }

    // â”€â”€ SSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function connectSSE() {
      const es = new EventSource('/events');
      const pill = document.getElementById('conn-pill');
      const label = document.getElementById('conn-label');
      es.addEventListener('connected', e => {
        const d = JSON.parse(e.data);
        pill.classList.add('live');
        label.textContent = `Live Â· ${d.unit}`;
      });
      es.addEventListener('mission_assigned', e => {
        showAlert(JSON.parse(e.data));
      });
      es.addEventListener('availability_update', () => loadStats());
      es.addEventListener('status_update', e => {
        const data = JSON.parse(e.data);
        if (data.status === 'resolved') { currentMission = null; showScreen('screen-standby'); }
      });
      es.onerror = () => {
        pill.classList.remove('live');
        label.textContent = 'Reconnectingâ€¦';
      };
    }

    async function checkExistingMission() {
      try {
        const res = await fetch('/api/mission');
        const data = await res.json();
        if (data.status === 'waiting_for_driver') showAlert(data);
        else if (data.status === 'en_route') showEnRoute(data);
      } catch (e) { }
    }
  </script>
</body>

</html>